# Simulation Algorithm and Assumptions

This document describes the inner workings of the Centrevo simulation engine. It is intended for both developers who need to understand the code structure and biologists who need to understand the modeling assumptions.

## Overview

Centrevo simulates the evolution of centromeres using a **Wright-Fisher forward-time simulation** model. It tracks a population of diploid individuals (each with two haplotypes/chromosomes) over discrete non-overlapping generations.

The core cycle for each generation is:
1.  **Mutation**: New variations are introduced.
2.  **Recombination**: Genetic material is shuffled between chromosomes.
3.  **Selection & Reproduction**: Parents are selected based on fitness to produce the next generation.

## 1. Simulation State

The simulation tracks a `Population` of `N` diploid individuals.

*   **Individuals**: Each individual has two `Haplotype`s (diploid).
*   **Haplotypes**: Consist of one (or more) `Chromosome`s.
*   **Chromosomes**: Represent linear DNA sequences composed of nucleotides (A, C, G, T).

**Biologically**: This represents a sexually reproducing, diploid population.

## 2. The Evolutionary Cycle (Algorithm)

For each generation `t` to `t+1`:

### Step 1: Parent Selection
Parents are selected from the current population to produce the next generation.

*   **Source**: Population at generation `t`.
*   **Method**: Fitness-proportional selection (Roulette Wheel).
    *   Uses **intrinsic fitness** values calculated when the parents were born.
    *   Selection probability $P(i) \propto w_i$.
*   **Constraint**: Self-fertilization is disallowed (parents in a pair must be distinct).

### Step 2: Offspring Generation (Parallelized)
New individuals are generated by simulating meiosis and fertilization for each selected parent pair.

#### A. Gamete Production (Meiosis & Mutation)
For each parent, a single gamete (haplotype) is produced:

1.  **Meiosis (Recombination)**:
    *   The parent's two haplotypes undergo recombination.
    *   **Break Formation**: Breaks occur based on `break_prob` (Geometric distribution).
    *   **Repair**: Breaks are repaired as **Crossovers** or **Gene Conversions** (`crossover_prob`).
    *   **Homology Search**: Repair uses homology-directed search (`search_window`, `homology_strength`).

2.  **Assortment**:
    *   One of the two recombinant haplotypes is randomly selected to become the gamete (Mendelian segregation).

3.  **Mutation**:
    *   The gamete undergoes mutation *after* meiosis.
    *   **Substitutions**: Random base changes (`mutation_rate`).
    *   **Indels**: Insertions/Deletions (`indel_rate`).
    *   **Note**: This simulates germline mutations passed to offspring.

#### B. Fertilization & Fitness Assignment
1.  **Fertilization**:
    *   Gamete from Parent 1 + Gamete from Parent 2 = New Diploid Individual.
    
2.  **Intrinsic Fitness Calculation**:
    *   The new individual's fitness is computed **immediately** upon creation.
    *   **Components**: GC Content, Length, Sequence Similarity.
    *   This "intrinsic" fitness is stored (cached) with the individual and will be used when *it* becomes a parent in the next generation.
    *   **Assumption**: Fitness is determined by genotype at birth and does not change (no somatic evolution or plasticity).

### Step 3: Population Replacement
The new offspring completely replace the old population (discrete generations).

## 3. Key Assumptions & Constraints

1.  **Discrete Generations**: The model uses non-overlapping generations. Parents die after reproduction.
2.  **Fixed Population Size**: The population size `N` remains constant throughout the simulation (soft selection).
3.  **Soft Selection**: Fitness determines the *relative* probability of reproduction. The total number of offspring is fixed, regardless of absolute population fitness (no extinction risk from low fitness).
4.  **Infinite Sites (Locally)**: While the genome is finite, the sequence space is effectively infinite. Back-mutations are allowed but rare.
5.  **No Linkage Disequilibrium (Initial)**: Unless specified, the simulation often starts with uniform or identical populations, but LD builds up due to physical linkage.
6.  **Recombination Validity**: Crossovers and gene conversions can be computationally complex if chromosome lengths differ significantly. The engine handles this by mapping relative positions, but extreme length differences can lead to simulation artifacts or "clamping" of events.

## 4. Code Map

*   `crates/sim/src/simulation/engine.rs`: The main loop (`step()`, `apply_mutation()`, `apply_recombination()`, `generate_offspring()`).
*   `crates/sim/src/evolution/mutation.rs`: Logic for substitutions and indels.
*   `crates/sim/src/evolution/recombination.rs`: Logic for DSBs, homology search, crossovers, and gene conversion.
*   `crates/sim/src/evolution/selection.rs`: Fitness function definitions.
